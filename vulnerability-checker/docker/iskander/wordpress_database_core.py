import mysql.connector
from mysql.connector import Error
import hashlib
import os, sys
from hashlib import sha1

def scan(folder):
    data = {}
    for dirpath, dirs, files in os.walk(folder):  
        for filename in files:
            fname = os.path.join(dirpath,filename)
            data[fname[10:]] = get_hash(fname, "sha1")
    return(data)

def sha256(s):
    h = hashlib.sha1() # Construct a hash object using our selected hashing algorithm
    h.update('My content'.encode('utf-8')) # Update the hash using a bytes object
    print(h.hexdigest()) # Print the hash value as a hex string
    print(h.digest()) # Print the hash value as a bytes object

def get_hash(f_path, mode='md5'):
    h = hashlib.new(mode)
    with open(f_path, 'rb') as file:
        data = file.read()
    h.update(data)
    digest = h.hexdigest()
    return digest

def get_hash_memory_optimized(f_path, mode='md5'):
    h = hashlib.new(mode)
    with open(f_path, 'rb') as file:
        block = file.read(512)
        while block:
            h.update(block)
            block = file.read(512)

    return h.hexdigest()

def insert(version, sha1, file):
    try:
        connection = mysql.connector.connect(host='127.0.0.1',
					     port=6033,
                                             database='app_db',
                                             user='db_user',
                                             password='db_user_pass')


        mySql_insert_query = f"""INSERT INTO core (version, sha1, file) 
                               VALUES 
                            ('{version}', '{sha1}', '{file}') """

        cursor = connection.cursor()
        cursor.execute(mySql_insert_query)
        connection.commit()
        cursor.close()

    except mysql.connector.Error as error:
        print("Failed to insert record into Laptop table {}".format(error))

    finally:
        if connection.is_connected():
            connection.close()
            print("MySQL connection is closed")

def doit(version, folder):
    try:
        connection = mysql.connector.connect(host='127.0.0.1',
                                             database='app_db',
                                             user='db_user',
                                             password='db_user_pass',
					     port=6033)

        for file, sha1 in scan(folder).items():
            mySql_insert_query = f"""INSERT INTO core (version, sha1, file) 
                               VALUES 
                            ('{version}', '{sha1}', '{file}') """
            cursor = connection.cursor()
            cursor.execute(mySql_insert_query)
            connection.commit()

            cursor.close()

    except mysql.connector.Error as error:
        print("Failed to insert record into Laptop table {}".format(error))

    finally:
        if connection.is_connected():
            connection.close()
            print("MySQL connection is closed")

doit(sys.argv[1], "wordpress/")
